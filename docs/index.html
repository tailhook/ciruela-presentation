<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title>P2P for Servers</title><meta charset="utf-8"></meta><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/highlight.css" media="all"></link><link rel="stylesheet" href="css/fred.css" media="all"></link><link rel="stylesheet" href="main.css" media="screen,projection"></link><style>
                        .slide-number { display: none; }
                    </style></head><body class="impress-not-supported"><div id="impress"><div class="step step-level-1" step="0" id="initial" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="p2p-for-servers">P2P for Servers</h1><img src="qrcode.svg" alt="https://tailhook.github.io/ciruela-presentation/"></img></div><div class="step step-level-1" step="1" id="agenda" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="agenda">Agenda</h1><ul><li>Patterns</li><li>The Tool</li><li>Use Cases</li></ul></div><div class="step step-level-1" step="2" data-x="3000" data-y="-1000" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-z="0"><h1 id="why">Why?</h1></div><div class="step step-level-1" step="3" id="arch-start" data-x="4400" data-y="-1000" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-z="0"><img src="classic_arch.svg" width="1200px"></img></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="5800" data-y="-1000" data-z="0"><img src="classic_memcached_arch.svg" width="1200px"></img></div><div class="step step-level-1 oneatatime" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="7200" data-y="-1000" data-z="0"><h1 id="db">DB</h1><ul><li>Persistent</li><li>Relatively slow</li></ul></div><div class="step step-level-1 oneatatime" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8600" data-y="-1000" data-z="0"><h1 id="cache">Cache</h1><ul><li>Quite fast</li><li>Data loss is norm</li></ul></div><div class="step step-level-1 oneatatime" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="10000" data-y="-1000" data-z="0"><h1 id="source-code">Source Code</h1><ul><li>Zero-cost</li><li>Reliable</li><li>Read-only</li></ul></div><div class="step step-level-1 oneatatime" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11400" data-y="-1000" data-z="0"><h1 id="id1">Source Code</h1><p>Source code <strong>can</strong> contain data:</p><ol><li>Gender options</li><li>Shop products</li><li>Game content</li><li>Site news</li></ol></div><div class="step step-level-1 oneatatime" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="-1000" data-z="0"><h1 id="id2">Source Code</h1><ul><li>May have editable data</li><li>CI/CD</li><li>3-5 <span class="big">&#x1F574;</span></li></ul></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14200" data-y="-1000" data-z="0"><h1 id="takeaway">Takeaway</h1><p>Source code <strong>is</strong> your DB until you have &gt; 5 users.</p><img src="lektor.jpg" width="400" class="blog-logo"></img><img src="publii.svg" width="400" class="blog-logo"></img></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="15600" data-y="-1000" data-z="0"><h1 id="db-cache-code">DB? Cache? Code?</h1><p>Currency Rates</p><p>(updated daily)</p></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17000" data-y="-1000" data-z="0"><h1 id="id3">DB? Cache? Code?</h1><p>Categories</p><img src="categories_wikipedia.svg" height="800" class="image-categories"></img></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="18400" data-y="-1000" data-z="0"><h1 id="categories">Categories</h1><img src="categories_operation.jpg" width="1000"></img></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19800" data-y="-1000" data-z="0"><img src="refresh.jpg" height="800"></img></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="21200" data-y="-1000" data-z="0"><img src="congested_port.jpg" height="800"></img></div><div class="step step-level-1" step="16" id="ciruela-links" data-x="3000" data-y="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-z="0"><h1 id="ciruela">Ciruela</h1><ul><li><a href="https://github.com/tailhook/ciruela">https://github.com/tailhook/ciruela</a></li><li><a href="https://ciruela.rtfd.org">https://ciruela.rtfd.org</a></li></ul><img src="ciruela_qr.svg" alt="https://ciruela.rtfd.org/"></img></div><div class="step step-level-1" step="17" data-x="4400" data-y="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-z="0"><img src="ciruela_upload.svg" width="1200"></img></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="5800" data-y="0" data-z="0"><h1 id="thats-it">Thats It!</h1></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="7200" data-y="0" data-z="0"><img src="ciruela_pings.svg" width="800"></img></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8600" data-y="0" data-z="0"><img src="ciruela_hashes.svg" height="800"></img></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="10000" data-y="0" data-z="0"><img src="ciruela_new_server.svg" width="1200"></img></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11400" data-y="0" data-z="0"><img src="ciruela_merkle_tree.svg" height="800"></img></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><img src="ciruela_hardlinks.jpg" height="800"></img></div><div class="step step-level-1" step="24" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14200" data-y="0" data-z="0"><h1 id="hashes-hardlinks">Hashes+Hardlinks</h1><ul><li>Save disk space</li><li>Save bandwidth</li></ul></div><div class="step step-level-1" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="15600" data-y="0" data-z="0"><img src="ciruela_exchange.jpg" width="1100"></img></div><div class="step step-level-1" step="26" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17000" data-y="0" data-z="0"><img src="ciruela_keys.svg" height="700"></img></div><div class="step step-level-1" step="27" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="18400" data-y="0" data-z="0"><img src="ciruela_dirs.svg" width="1100"></img></div><div class="step step-level-1" step="28" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19800" data-y="0" data-z="0"><pre class="highlight code text">ciruela sync \
 --append ./local1:/dir1/v1.0.0 \
 --replace ./local2:/dir2/current \
 cluster1.org cluster2.org</pre></div><div class="step step-level-1" step="29" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="21200" data-y="0" data-z="0"><h1 id="security-warning">Security Warning</h1><ul><li>TLS is on to do list</li><li>Use behind firewall</li></ul></div><div class="step step-level-1" step="30" id="use-cases" data-x="3000" data-y="1000" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-z="0"><h1 id="use-cases">Use Cases</h1><p><em>&#x2025; and to do's</em></p></div><div class="step step-level-1" step="31" data-x="4400" data-y="1000" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-z="0"><h1 id="always-available">Always Available</h1><p><em>&#x2025; and dynamic</em></p><ul><li>Site categories</li><li>Currency rates</li><li>Feature flags</li></ul></div><div class="step step-level-1" step="32" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="5800" data-y="1000" data-z="0"><h1 id="id4">Always Available</h1><pre class="highlight code python"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"/sync/cur/data.json"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></pre><p><em>no network calls on start of app</em></p></div><div class="step step-level-1" step="33" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="7200" data-y="1000" data-z="0"><h1 id="cheap-to-check">Cheap to Check</h1><pre class="highlight code python"><span class="nb">dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"/sync/cur"</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">dir</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_ctime</span> <span class="o">!=</span> <span class="n">old_time</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">cache</span></pre></div><div class="step step-level-1" step="34" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8600" data-y="1000" data-z="0"><h1 id="push-new-data">Push New Data</h1><pre class="highlight code python"><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">d</span><span class="p">:</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">'/data.json'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="n">s</span> <span class="n">f</span><span class="p">:</span>
     <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
  <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span>
      <span class="s1">'cirula'</span><span class="p">,</span> <span class="s1">'sync'</span><span class="p">,</span>
      <span class="s1">'--replace'</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">':/sync/cur'</span><span class="p">,</span>
      <span class="s1">'entry-point.example.org'</span><span class="p">])</span></pre></div><div class="step step-level-1" step="35" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="10000" data-y="1000" data-z="0"><h1 id="refreshable-things">Refreshable Things</h1><ul><li>Configs</li><li>Translations</li><li>Game content</li></ul><p><em>&#x2025;. removing file works!</em></p></div><div class="step step-level-1" step="36" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11400" data-y="1000" data-z="0"><h1 id="edit-on-100-servers">&#x1F57A; Edit on 100 Servers</h1><pre class="highlight code text">ciruela edit \
 -d /sync/cur -f /data.json \
 cluster1.org cluster2.org</pre></div><div class="step step-level-1" step="37" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="1000" data-z="0"><h1 id="basic-things">Basic Things</h1><ul><li>Container Images</li><li>Static Sites</li><li>Container Cache for Vagga</li></ul></div><div class="step step-level-1" step="38" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14200" data-y="1000" data-z="0"><h1 id="debian-repository">&#x1F57A; Debian Repository</h1><ul><li>Only download index</li><li>Upload new index + .deb</li><li>Atomically replace</li></ul></div><div class="step step-level-1" step="39" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="15600" data-y="1000" data-z="0"><h1 id="container-audit">Container Audit</h1><ul><li>Download index directly from cluster</li><li>Check</li><li>Remember hash</li></ul></div><div class="step step-level-1" step="40" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17000" data-y="1000" data-z="0"><h1 id="transactional-fs">&#x1F57A; Transactional FS</h1><ul><li>Mount via fuse</li><li>Download files on access</li><li>Sync back on unmount</li></ul></div><div class="step step-level-1" step="41" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="18400" data-y="1000" data-z="0"><h1 id="python-lab">Python Lab</h1></div><div class="step step-level-1" step="42" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19800" data-y="1000" data-z="0"><p>TODO</p></div><div class="step step-level-1" step="43" id="questions" data-x="1000" data-y="0" data-scale="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-z="0"><h1 id="questions">Questions</h1><div class="final-qrcode"><img src="qrcode.svg" alt="https://tailhook.github.io/ciruela-presentation/" width="200px"></img><p>Presentation</p></div><div class="final-qrcode"><img src="ciruela_qr.svg" alt="https://ciruela.rtfd.org/" width="200px"></img>Documentation</div></div></div><div id="slide-number" class="slide-number">
                    1
                </div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr class="slide-number"><th>G</th><td>Go to slide number</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript">
                    var change_link_targets = true;
                    </script><script type="text/javascript">
                    var use_touch_controls = false;
                    </script><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript" src="js/slide-numbers.js"></script><script type="text/javascript" src="js/logos.js"></script><script type="text/javascript" src="js/link-targets.js"></script><script type="text/javascript" src="js/oneatatime.js"></script><script type="text/javascript" src="js/touch-controls.js"></script><script type="text/javascript" src="keys.js"></script><script type="text/javascript">
                        function change_slide_number(e) {};
                        function goto_slide_number(e) {};
                    
                    document.getElementById("impress").addEventListener("impress:stepenter", change_slide_number, false);
                    document.addEventListener("keypress", goto_slide_number);
                </script></body></html>